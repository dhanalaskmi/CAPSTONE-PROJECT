{% extends "base.html" %}
{% block title %}Chat History - Voice AI{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-4rem)] bg-gradient-to-br from-slate-50 via-primary-50 to-slate-50 px-4 py-8">
  <div class="max-w-4xl mx-auto">
    <!-- Header Section -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h1 class="text-4xl font-bold font-display text-slate-900 mb-2">Chat History</h1>
          <p class="text-lg text-slate-600">Review all your past conversations</p>
        </div>
        <div class="text-right">
          <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-primary-500 to-accent-600 flex items-center justify-center shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 mb-8">
      <div class="flex flex-col md:flex-row gap-4 items-end">
        <div class="flex-1">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Filter by Type</label>
          <div class="flex gap-3">
            <button 
              onclick="filterMessages('all')" 
              class="filter-btn px-4 py-2 rounded-lg font-medium transition-all text-sm active"
              data-filter="all"
            >
              All Messages
            </button>
            <button 
              onclick="filterMessages('user')" 
              class="filter-btn px-4 py-2 rounded-lg font-medium transition-all text-sm"
              data-filter="user"
            >
              Your Messages
            </button>
            <button 
              onclick="filterMessages('assistant')" 
              class="filter-btn px-4 py-2 rounded-lg font-medium transition-all text-sm"
              data-filter="assistant"
            >
              AI Responses
            </button>
          </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search messages..." 
            class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-sm"
            onkeyup="searchMessages()"
          />
          <button 
            onclick="exportHistory()"
            class="bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-700 hover:to-primary-600 text-white px-4 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    {% if messages %}
    <div class="grid md:grid-cols-3 gap-4 mb-8">
      <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-600 text-sm font-medium">Total Messages</p>
            <p class="text-3xl font-bold text-slate-900 mt-2">{{ messages|length }}</p>
          </div>
          <div class="h-12 w-12 rounded-lg bg-primary-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-600 text-sm font-medium">Your Messages</p>
            <p class="text-3xl font-bold text-slate-900 mt-2">{{ messages|selectattr('role', 'equalto', 'user')|list|length }}</p>
          </div>
          <div class="h-12 w-12 rounded-lg bg-primary-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-600 text-sm font-medium">AI Responses</p>
            <p class="text-3xl font-bold text-slate-900 mt-2">{{ messages|selectattr('role', 'equalto', 'assistant')|list|length }}</p>
          </div>
          <div class="h-12 w-12 rounded-lg bg-accent-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-accent-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Messages Container -->
    {% if messages %}
    <div id="messagesContainer" class="space-y-4">
      {% for m in messages %}
      <div class="message-item {% if m.role=='user' %}user-message{% else %}assistant-message{% endif %}" data-role="{{ m.role }}" data-text="{{ m.text|lower }}">
        <div class="flex {% if m.role=='user' %}justify-end{% else %}justify-start{% endif %}">
          <div class="max-w-2xl">
            <!-- Message Card -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 hover:shadow-xl transition-all duration-200">
              <!-- Message Header -->
              <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-200">
                <div class="flex items-center gap-3">
                  {% if m.role=='user' %}
                    <div class="h-8 w-8 rounded-lg bg-primary-100 flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-600" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
                      </svg>
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-slate-900">You</p>
                      <p class="text-xs text-slate-500">{{ m.created_at.strftime('%b %d, %Y') }}</p>
                    </div>
                  {% else %}
                    <div class="h-8 w-8 rounded-lg bg-accent-100 flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-accent-600" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
                      </svg>
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-slate-900">Voice AI</p>
                      <p class="text-xs text-slate-500">{{ m.created_at.strftime('%b %d, %Y') }}</p>
                    </div>
                  {% endif %}
                </div>
                <div class="text-right">
                  <p class="text-xs text-slate-500 font-mono">{{ m.created_at.strftime('%H:%M:%S') }}</p>
                </div>
              </div>

              <!-- Message Content -->
              <div class="prose prose-sm max-w-none">
                <p class="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{{ m.text }}</p>
              </div>

              <!-- Message Footer -->
              <div class="flex items-center gap-2 mt-4 pt-4 border-t border-slate-200">
                <button 
                  class="copy-btn flex items-center gap-1 px-3 py-2 text-xs font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all"
                  title="Copy message"
                  data-text="{{ m.text }}"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                  </svg>
                  Copy
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Empty State -->
    {% else %}
    <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-12 text-center">
      <div class="flex justify-center mb-6">
        <div class="h-20 w-20 rounded-full bg-slate-100 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
      </div>
      <h3 class="text-2xl font-bold text-slate-900 mb-2">No Chat History</h3>
      <p class="text-slate-600 mb-6">Start a conversation in the dashboard to see your chat history here.</p>
      <a href="{{ url_for('dashboard') }}" class="inline-flex items-center gap-2 bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-700 hover:to-primary-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        Go to Dashboard
      </a>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .filter-btn {
    background-color: #f1f5f9;
    color: #64748b;
  }

  .filter-btn:hover,
  .filter-btn.active {
    background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%);
    color: white;
  }

  .message-item {
    animation: slideInUp 0.3s ease-out;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .prose p {
    margin: 0;
  }

  #messagesContainer::-webkit-scrollbar {
    width: 6px;
  }

  #messagesContainer::-webkit-scrollbar-track {
    background: transparent;
  }

  #messagesContainer::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  #messagesContainer::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>

<script>
  function filterMessages(type) {
    const items = document.querySelectorAll('.message-item');
    const buttons = document.querySelectorAll('.filter-btn');

    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Filter messages
    items.forEach(item => {
      if (type === 'all') {
        item.style.display = 'flex';
      } else if (item.dataset.role === type) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });
  }

  function searchMessages() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const items = document.querySelectorAll('.message-item');

    items.forEach(item => {
      const text = item.dataset.text;
      if (text.includes(query)) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });
  }

  function copyToClipboard(btn) {
    const text = btn.dataset.text;
    navigator.clipboard.writeText(text).then(() => {
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
      btn.classList.add('bg-green-100', 'text-green-700');
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('bg-green-100', 'text-green-700');
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
    });
  }

  // Add click listeners to all copy buttons
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      copyToClipboard(this);
    });
  });

  function exportHistory() {
    const items = document.querySelectorAll('.message-item');
    let text = 'Voice AI Chat History\n';
    text += '=' .repeat(50) + '\n\n';

    items.forEach((item, index) => {
      const role = item.dataset.role === 'user' ? 'You' : 'Voice AI';
      const messageContent = item.querySelector('.prose p').textContent;
      text += `[${index + 1}] ${role}:\n${messageContent}\n\n`;
    });

    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat-history-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }
</script>
{% endblock %}